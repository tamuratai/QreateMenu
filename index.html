<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>メニューブックQR 生成</title>

  <style>
    :root{
      --bg:#0b0f14;
      --card:#111824;
      --text:#e8eef6;
      --muted:#a9b6c6;
      --line:rgba(255,255,255,.12);
      --danger:#ff6b6b;
      --radius:16px;
      --pad:14px;
      --h:56px;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background: radial-gradient(1200px 800px at 50% -10%, rgba(110,231,255,.08), transparent 55%), var(--bg);
      color:var(--text);
    }
    header{
      padding: 16px 16px 10px;
      position: sticky;
      top: 0;
      background: linear-gradient(to bottom, rgba(11,15,20,.92), rgba(11,15,20,.72));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
      z-index: 10;
    }
    header h1{ font-size: 18px; margin:0; letter-spacing: .2px; }
    header .sub{ margin-top:6px; font-size: 12px; color: var(--muted); line-height: 1.4; }

    main{
      padding: 12px 16px 110px;
      max-width: 860px;
      margin: 0 auto;
    }
    .card{
      background: linear-gradient(180deg, rgba(17,24,36,.92), rgba(15,22,33,.92));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: var(--pad);
      box-shadow: var(--shadow);
    }
    .grid{ display:grid; gap: 12px; }
    .two{ display:grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 720px){ .two{ grid-template-columns: 1fr 1fr; } }

    label{ display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .field{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 14px;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .field input{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      color: var(--text);
      font-size: 18px;
      line-height: 1.2;
    }
    .field input[readonly]{ opacity:.85; }
    .hint{ margin-top:6px; font-size: 12px; color: var(--muted); }

    .seg{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .seg button{
      flex:1;
      min-width: 140px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 16px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .seg button.active{
      background: rgba(110,231,255,.18);
      border-color: rgba(110,231,255,.38);
    }
    .warn{ color: var(--danger); white-space: pre-line; font-size: 13px; margin-top: 10px; }

    details{
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      padding: 10px 12px;
    }
    summary{
      cursor:pointer;
      color: var(--muted);
      font-size: 12px;
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    code{
      display:block;
      margin-top:10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      word-break: break-all;
      color: var(--text);
      font-size: 12px;
    }

    /* 合成画像表示 */
    .qrWrap{
      display:flex;
      gap: 12px;
      align-items:flex-start;
      flex-wrap: wrap;
      margin-top: 12px;
      display:none;
    }
    #previewCanvas{
      background: #fff;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.20);
      display:block;
      width: 260px;
      height: auto;
    }
    .qrInfo{ flex: 1; min-width: 220px; }
    .kv{ color: var(--muted); font-size: 12px; margin-top: 6px; }

    /* 下部固定アクションバー */
    .bar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(11,15,20,.96), rgba(11,15,20,.72));
      border-top: 1px solid var(--line);
      backdrop-filter: blur(10px);
      z-index: 20;
    }
    .barInner{
      max-width: 860px;
      margin: 0 auto;
      display:flex;
      gap: 10px;
    }
    .btn{
      height: var(--h);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 16px;
      padding: 0 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      flex:1;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btnPrimary{
      background: linear-gradient(180deg, rgba(110,231,255,.22), rgba(110,231,255,.10));
      border-color: rgba(110,231,255,.35);
    }
    .btn:active{ transform: translateY(1px); }
    a.dl{ flex:1; text-decoration:none; display:none; }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(86px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,.65);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease;
    }
    .toast.show{ opacity:1; }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>
<header>
  <h1>メニューブックQR 生成</h1>
  <div class="sub">
    税率はボタン選択（8%/10%）。税は税抜入力から自動計算。<br>
    生成画像は「品名＋QR＋請求金額」を1枚にまとめます。
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <div class="two">
        <div>
          <label>店舗コード（半角数字 1〜4桁 / 右詰め・左0埋め）</label>
          <div class="field">
            <input id="storeCode" type="tel" inputmode="numeric" autocomplete="off" placeholder="例: 12 → 0012" maxlength="4">
          </div>
          <div class="hint">カンマは入力しません（生成時に固定付与）。</div>
        </div>

        <div>
          <label>商品コード（半角数字 1〜4桁 / 右詰め・左0埋め）</label>
          <div class="field">
            <input id="itemCode" type="tel" inputmode="numeric" autocomplete="off" placeholder="例: 7 → 0007" maxlength="4">
          </div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <label>税率（排他的選択 / デフォルト10%）</label>
        <div class="seg">
          <button id="btnTax10" type="button" class="active" aria-pressed="true">10%</button>
          <button id="btnTax8" type="button" aria-pressed="false">8%（軽減）</button>
        </div>
        <div class="hint">8%を選ぶと軽減税率フラグ（*）も自動で反映されます。</div>
      </div>

      <div style="margin-top:12px;">
        <label>品名（最大20 / 左詰め・右スペース / カンマ不可）</label>
        <div class="field">
          <input id="name" type="text" inputmode="text" autocomplete="off" placeholder="例: Shampoo-A 500ml" maxlength="20">
        </div>
        <div class="hint">保存ファイル名には「フォーム入力の品名（余白なし）」を使います。</div>
      </div>

      <div class="two" style="margin-top:12px;">
        <div>
          <label>税抜き価格（半角数字 最大6 / 左詰め・右スペース）</label>
          <div class="field">
            <input id="priceEx" type="tel" inputmode="numeric" autocomplete="off" placeholder="例: 1000" maxlength="6">
          </div>
        </div>
        <div>
          <label>税（自動計算 / 左詰め・右スペース）</label>
          <div class="field">
            <input id="taxAmount" type="text" readonly value="">
          </div>
          <div class="hint">税抜き価格または税率変更で更新します。</div>
        </div>
      </div>

      <div class="two" style="margin-top:12px;">
        <div>
          <label>請求金額（税抜＋税）</label>
          <div class="field">
            <input id="totalAmount" type="text" readonly value="">
          </div>
        </div>
        <div>
          <div class="hint" style="margin-top:28px;">
            ※請求金額はQR画像の下にも表示されます（PNG内）。
          </div>
        </div>
      </div>

      <div id="msg" class="warn"></div>

      <details>
        <summary>生成レコードの確認（固定長48 / スペース含む）</summary>
        <code id="payload" class="mono"></code>
        <div class="hint">スペース可視化（表示専用）：</div>
        <code id="payloadVisible" class="mono"></code>
      </details>

      <div class="qrWrap" id="qrSection">
        <canvas id="previewCanvas" width="320" height="400"></canvas>
        <div class="qrInfo">
          <div class="kv">PNG保存名：<span class="mono" id="fname"></span></div>
          <div class="kv">※プレビューは合成画像（品名＋QR＋請求金額）です。</div>
        </div>
      </div>

      <!-- QR生成用（非表示） -->
      <div id="qrcode" style="position:absolute; left:-99999px; top:-99999px;"></div>
    </section>
  </div>
</main>

<div class="bar">
  <div class="barInner">
    <button class="btn btnPrimary" id="btnGen">QR生成</button>

    <a class="dl" id="btnDl" download="menu_qr.png">
      <div class="btn">PNG保存</div>
    </a>

    <button class="btn" id="btnCopy" type="button">文字列コピー</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  const $ = (id) => document.getElementById(id);

  // 固定長（Excel仕様）
  const LEN_STORE = 4, LEN_ITEM = 4, LEN_TAX = 2, LEN_REDUCED = 1, LEN_NAME = 20, LEN_PRICE_EX = 6, LEN_TAX_AMT = 5;

  // 税率状態（デフォルト10）
  let currentTaxRate = 10; // 8 or 10

  function isHalfWidthDigits(s){ return /^[0-9]+$/.test(s); }
  function padLeftFill(s, len, fillChar){
    s = String(s ?? "");
    if (s.length > len) return null;
    return fillChar.repeat(len - s.length) + s;
  }
  function padRightFill(s, len, fillChar){
    s = String(s ?? "");
    if (s.length > len) return null;
    return s + fillChar.repeat(len - s.length);
  }
  function setMessage(text){ $("msg").textContent = text || ""; }
  function visualizeSpaces(s){ return s.replace(/ /g, "·"); }

  function showToast(text){
    const t = $("toast");
    t.textContent = text;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 1200);
  }

  function sanitizeFilenamePart(s){
    let t = String(s ?? "");
    t = t.replace(/[\\\/:*?"<>|]/g, "_");
    t = t.replace(/[\. ]+$/g, "");
    if (t.trim() === "") t = "noname";
    if (t.length > 60) t = t.slice(0, 60);
    return t;
  }

  function formatYenLike(n){
    if (!Number.isFinite(n)) return "";
    return String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

  function calcTax(priceEx, rate){
    // 端数処理：ここを変更すればルール変更できます
    // return Math.round(priceEx * rate / 100); // 四捨五入
    // return Math.ceil(priceEx * rate / 100);  // 切り上げ
    return Math.floor(priceEx * rate / 100);   // 切り捨て（現状）
  }

  function updateTaxAuto(){
    const exRaw = $("priceEx").value.trim();
    if (!exRaw || !isHalfWidthDigits(exRaw)) {
      $("taxAmount").value = "";
      $("totalAmount").value = "";
      return;
    }
    const ex = parseInt(exRaw, 10);
    const tax = calcTax(ex, currentTaxRate);
    const total = ex + tax;

    $("taxAmount").value = String(tax);                 // 表示は数値のみ
    $("totalAmount").value = formatYenLike(total);      // 見やすくカンマ
  }

  function setTaxRate(rate){
    currentTaxRate = rate;
    const is10 = (rate === 10);
    $("btnTax10").classList.toggle("active", is10);
    $("btnTax10").setAttribute("aria-pressed", is10 ? "true" : "false");
    $("btnTax8").classList.toggle("active", !is10);
    $("btnTax8").setAttribute("aria-pressed", !is10 ? "true" : "false");
    updateTaxAuto();
  }

  // 税率ボタン
  $("btnTax10").addEventListener("click", () => setTaxRate(10));
  $("btnTax8").addEventListener("click", () => setTaxRate(8));

  // 税抜入力変更で自動再計算
  $("priceEx").addEventListener("input", updateTaxAuto);

  // 入力中に非数値が混ざったら軽く整える（任意）
  $("priceEx").addEventListener("blur", () => {
    const v = $("priceEx").value.trim();
    if (v && isHalfWidthDigits(v)) $("priceEx").value = String(parseInt(v, 10));
  });

  function buildPayload(){
    const errors = [];
    const header = "K";
    const sep = ",";

    const storeIn = $("storeCode").value.trim();
    if (!storeIn || !isHalfWidthDigits(storeIn)) errors.push("店舗コード：半角数字で1～4桁入力してください。");
    const store = padLeftFill(storeIn, LEN_STORE, "0");
    if (store === null) errors.push(`店舗コード：${LEN_STORE}文字を超えています。`);

    const itemIn = $("itemCode").value.trim();
    if (!itemIn || !isHalfWidthDigits(itemIn)) errors.push("商品コード：半角数字で1～4桁入力してください。");
    const item = padLeftFill(itemIn, LEN_ITEM, "0");
    if (item === null) errors.push(`商品コード：${LEN_ITEM}文字を超えています。`);

    // 税率フィールド（2文字）
    const tax = (currentTaxRate === 8) ? "08" : "10";
    // 軽減税率フラグ（8%のときだけ "*"、それ以外はスペース）
    const reduced = (currentTaxRate === 8) ? "*" : " ";

    const nameRaw = $("name").value.trim();
    if (!nameRaw) errors.push("品名：必須です。");
    if (nameRaw.includes(",")) errors.push("品名：カンマ「,」は使用できません（区切りに使用します）。");
    const name = padRightFill(nameRaw, LEN_NAME, " ");
    if (name === null) errors.push(`品名：${LEN_NAME}文字を超えています。`);

    const priceExIn = $("priceEx").value.trim();
    if (!priceExIn || !isHalfWidthDigits(priceExIn)) errors.push("税抜き価格：半角数字で1～6桁入力してください。");
    const priceEx = padRightFill(priceExIn, LEN_PRICE_EX, " ");
    if (priceEx === null) errors.push(`税抜き価格：${LEN_PRICE_EX}文字を超えています。`);

    // 税（自動計算）
    if (!priceExIn || !isHalfWidthDigits(priceExIn)) {
      errors.push("税：税抜き価格が未入力または不正です。");
    }
    let taxNum = 0;
    if (priceExIn && isHalfWidthDigits(priceExIn)) {
      taxNum = calcTax(parseInt(priceExIn, 10), currentTaxRate);
    }
    const taxAmtStr = String(taxNum);
    if (!isHalfWidthDigits(taxAmtStr)) errors.push("税：内部エラー（数値化失敗）。");
    if (taxAmtStr.length > LEN_TAX_AMT) errors.push(`税：${LEN_TAX_AMT}桁を超えています。`);
    const taxAmt = padRightFill(taxAmtStr, LEN_TAX_AMT, " ");

    if (errors.length) return { error: errors.join("\n") };

    const payload = header + store + sep + item + sep + tax + reduced + sep + name + sep + priceEx + sep + taxAmt;

    // 請求金額（表示/画像用）
    const total = parseInt(priceExIn, 10) + taxNum;

    return { payload, itemEncoded: item, nameRaw, taxNum, total };
  }

  function renderQRToHidden(payload){
    const qrDiv = $("qrcode");
    qrDiv.innerHTML = "";
    new QRCode(qrDiv, { text: payload, width: 220, height: 220, correctLevel: QRCode.CorrectLevel.M });
  }

  function drawCompositeImage(nameRaw, total, qrCanvas){
    // 合成キャンバス：上 品名 / 中 QR / 下 請求金額
    const canvas = $("previewCanvas");
    const ctx = canvas.getContext("2d");

    // サイズ設計
    const padding = 18;
    const titleH = 42;
    const footH  = 42;
    const qrSize = 220;

    const w = 320;
    const h = padding + titleH + 10 + qrSize + 10 + footH + padding;

    canvas.width = w;
    canvas.height = h;

    // 背景（白）
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, w, h);

    // テキスト（黒）
    ctx.fillStyle = "#000000";

    // 品名（上）
    ctx.font = "bold 18px system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    const title = nameRaw;
    ctx.fillText(title, w/2, padding + titleH/2);

    // QR
    const qrX = (w - qrSize)/2;
    const qrY = padding + titleH + 10;
    // QRの背景
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(qrX - 6, qrY - 6, qrSize + 12, qrSize + 12);
    // QR本体（qrcodejsのcanvasを描画）
    ctx.drawImage(qrCanvas, qrX, qrY, qrSize, qrSize);

    // 請求金額（下）
    ctx.fillStyle = "#000000";
    ctx.font = "bold 18px system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif";
    const amountText = "請求金額 " + formatYenLike(total);
    const footY = qrY + qrSize + 10 + footH/2;
    ctx.fillText(amountText, w/2, footY);
  }

  function enableDownload(filename){
    const a = $("btnDl");
    const canvas = $("previewCanvas");
    a.href = canvas.toDataURL("image/png");
    a.download = filename;
    a.style.display = "block";
  }

  $("btnGen").addEventListener("click", () => {
    setMessage("");
    $("btnDl").style.display = "none";
    $("payload").textContent = "";
    $("payloadVisible").textContent = "";
    $("qrcode").innerHTML = "";
    $("qrSection").style.display = "none";

    const res = buildPayload();
    if (res.error){
      setMessage(res.error);
      return;
    }

    $("payload").textContent = res.payload;
    $("payloadVisible").textContent = visualizeSpaces(res.payload);

    // QRを非表示領域に生成
    renderQRToHidden(res.payload);

    // qrcodejs が生成した canvas を取得して合成
    setTimeout(() => {
      const qrCanvas = $("qrcode").querySelector("canvas");
      if (!qrCanvas){
        setMessage("QR生成に失敗しました（canvasが取得できません）。");
        return;
      }

      // 合成描画（品名＋QR＋請求金額）
      drawCompositeImage(res.nameRaw, res.total, qrCanvas);

      // PNGファイル名：商品コード(エンコード後4文字) + "_" + 品名(フォーム入力のまま) + ".png"
      const fname = sanitizeFilenamePart(res.itemEncoded) + "_" + sanitizeFilenamePart(res.nameRaw) + ".png";
      $("fname").textContent = fname;

      enableDownload(fname);
      $("qrSection").style.display = "flex";

      showToast("QRを生成しました");
      console.log("[QR] len=", res.payload.length, res.payload);
    }, 60);
  });

  $("btnCopy").addEventListener("click", async () => {
    const text = $("payload").textContent || "";
    if (!text){
      setMessage("先にQR生成してください（レコード文字列が空です）。");
      return;
    }
    try{
      await navigator.clipboard.writeText(text);
      showToast("コピーしました");
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      showToast("コピーしました");
    }
  });

  // 初期状態：10%選択
  setTaxRate(10);
  updateTaxAuto();
</script>
</body>
</html>
