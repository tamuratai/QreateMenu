<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QreateMenu - Menu QR Generator</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/encoding-japanese/2.0.0/encoding.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

<style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; color: #333; }
    h2 { color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 10px; }
    .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; }
    input[type="text"], input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
    input[type="checkbox"] { transform: scale(1.5); margin-left: 5px; }
    .calculated-field { background-color: #e9ecef; color: #495057; }
    hr { margin: 20px 0; border: 0; border-top: 1px solid #ddd; }
    .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
    button { flex: 1; min-width: 140px; padding: 12px; font-size: 16px; border: none; border-radius: 4px; cursor: pointer; color: #fff; font-weight: bold; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    .btn-generate { background-color: #28a745; }
    .btn-save { background-color: #17a2b8; }
    .btn-print { background-color: #007bff; }
    .btn-copy { background-color: #6c757d; }
    
    #qr_display_area { 
        text-align: center; 
        margin-top: 20px; 
        padding: 10px; 
        min-height: 200px; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        border: 1px dashed #ccc; 
        background: white; 
    }
    #qr_display_area img { 
        max-width: 100%; 
        height: auto; 
        box-shadow: 0 0 5px rgba(0,0,0,0.2);
        image-rendering: pixelated; 
    }
    
    #generated_string { 
        font-family: monospace; 
        word-break: break-all; 
        background: #eee; 
        padding: 10px; 
        margin-top: 10px; 
        font-size: 14px; 
        border-radius: 4px;
    }
    #result_message { margin-top: 15px; font-weight: bold; text-align: center; min-height: 24px; }
    .success { color: green; }
    .error { color: red; }

    .settings-area { display: none; background: #fff3cd; padding: 10px; margin-bottom: 10px; border: 1px solid #ffeeba; }
    .settings-toggle { font-size: 12px; color: #856404; cursor: pointer; text-decoration: underline; margin-bottom: 10px; display: inline-block; }
</style>
</head>

<body>
<div class="container">
    <h2>Menu QR Generator</h2>

    <span class="settings-toggle" onclick="toggleSettings()">▼ プリンタ設定を表示/非表示</span>
    <div id="settings_area" class="settings-area">
        <div class="form-group"><label>Template URL (lbx):</label><input type="text" id="input_printfile" value="https://tamuratai.github.io/QreateMenu/AES-CUT_MenuQRcode.lbx"></div>
        <div class="form-group"><label>Media Size (bin):</label><input type="text" id="input_binfile" value="Width24mm"></div>
        <div class="form-group"><label>Copies:</label><input type="number" id="input_quantity" value="1"></div>
    </div>

    <div class="form-group">
        <label>店舗コード (4桁)</label>
        <input type="text" id="store_code" maxlength="4" placeholder="例: 1234">
    </div>
    <div class="form-group">
        <label>商品コード (4桁)</label>
        <input type="text" id="item_code" maxlength="4" placeholder="例: 0001">
    </div>
    <div class="form-group">
        <label>税率 (%)</label>
        <input type="number" id="tax_rate" value="10" onchange="calculatePreview()">
    </div>
    <div class="form-group">
        <label>軽減税率対象 <input type="checkbox" id="reduced_tax"></label>
    </div>
    <div class="form-group">
        <label>品名 (半角推奨)</label>
        <input type="text" id="item_name" placeholder="例: ﾐｿﾗｰﾒﾝ (全角も可)">
    </div>
    <div class="form-group">
        <label>税抜き価格</label>
        <input type="number" id="price_ex_tax" placeholder="例: 900" onchange="calculatePreview()">
    </div>
    <div class="form-group">
        <label>税額 (自動計算)</label>
        <input type="text" id="tax_amount_display" class="calculated-field" readonly>
    </div>
    <div class="form-group">
        <label>税込価格 (自動計算・印字用)</label>
        <input type="text" id="price_display" class="calculated-field" readonly>
    </div>

    <div class="btn-group">
        <button class="btn-generate" onclick="generateMenuData()">QR生成</button>
        <button class="btn-save" id="btn_save" onclick="saveQRImage()" disabled>QR画像保存 (PNG)</button>
        <button class="btn-copy" id="btn_copy" onclick="copyToClipboard()" disabled>文字列コピー</button>
        <button class="btn-print" id="btn_print" onclick="sendPrintRequest()" disabled>QR印字 (Brother)</button>
    </div>

    <div id="qr_display_area"><span style="color:#ccc;">QRコードがここに表示されます</span></div>
    
    <label style="font-size:12px; font-weight:bold; margin-top:10px; display:block;">生成データ (48byte):</label>
    <div id="generated_string">データ未生成</div>
    
    <div id="result_message"></div>
</div>

<script type="text/javascript">
    // --- ページ読み込み時 ---
    window.onload = function() {
        // 1. 保存されたデータがあれば復元
        restoreFormData();

        // 2. 結果パラメータの確認
        const urlParams = new URLSearchParams(window.location.search);
        const result = urlParams.get('result');
        if (result === 'success') showResult('印刷リクエスト送信成功', true);
        else if (result === 'fail') showResult('印刷リクエスト送信失敗', false);

        // 3. 復元した値に基づいて再計算・QR再表示（任意）
        calculatePreview();
        // データが十分にあれば自動でQR生成まで行っても良いが、
        // ここでは誤操作防止のため数値計算のみにとどめます。
        if(document.getElementById('item_name').value && document.getElementById('price_ex_tax').value){
             // 必要であればここで generateMenuData() を呼ぶことも可能
        }
    };

    // --- フォームデータの保存・復元ロジック ---
    function saveFormData() {
        const data = {
            store_code: document.getElementById('store_code').value,
            item_code: document.getElementById('item_code').value,
            tax_rate: document.getElementById('tax_rate').value,
            reduced_tax: document.getElementById('reduced_tax').checked,
            item_name: document.getElementById('item_name').value,
            price_ex_tax: document.getElementById('price_ex_tax').value,
            // 設定値も保存
            input_printfile: document.getElementById('input_printfile').value,
            input_binfile: document.getElementById('input_binfile').value,
            input_quantity: document.getElementById('input_quantity').value
        };
        sessionStorage.setItem('menu_qr_form_data', JSON.stringify(data));
    }

    function restoreFormData() {
        const saved = sessionStorage.getItem('menu_qr_form_data');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                if(data.store_code) document.getElementById('store_code').value = data.store_code;
                if(data.item_code) document.getElementById('item_code').value = data.item_code;
                if(data.tax_rate) document.getElementById('tax_rate').value = data.tax_rate;
                if(data.reduced_tax !== undefined) document.getElementById('reduced_tax').checked = data.reduced_tax;
                if(data.item_name) document.getElementById('item_name').value = data.item_name;
                if(data.price_ex_tax) document.getElementById('price_ex_tax').value = data.price_ex_tax;
                
                // 設定値
                if(data.input_printfile) document.getElementById('input_printfile').value = data.input_printfile;
                if(data.input_binfile) document.getElementById('input_binfile').value = data.input_binfile;
                if(data.input_quantity) document.getElementById('input_quantity').value = data.input_quantity;
            } catch (e) {
                console.error("Failed to restore form data", e);
            }
        }
    }

    // --- 以下、既存ロジック ---

    function toggleSettings() {
        const area = document.getElementById('settings_area');
        area.style.display = area.style.display === 'block' ? 'none' : 'block';
    }

    function calculatePreview() {
        const price = parseInt(document.getElementById('price_ex_tax').value) || 0;
        const rate = parseInt(document.getElementById('tax_rate').value) || 0;
        const taxAmt = Math.floor(price * (rate / 100));
        const total = price + taxAmt;
        
        document.getElementById('tax_amount_display').value = taxAmt + "円";
        document.getElementById('price_display').value = total + "円(税込)";
        return { taxAmt, total };
    }

    function toSjisBytes(str) {
        return Encoding.convert(Encoding.stringToCode(str), {to: 'SJIS', from: 'UNICODE'});
    }

    function padBytes(byteArray, targetLength, padByteVal, align) {
        if (byteArray.length >= targetLength) {
            return byteArray.slice(0, targetLength);
        }
        const diff = targetLength - byteArray.length;
        const pads = new Array(diff).fill(padByteVal);
        return align === 'right' ? pads.concat(byteArray) : byteArray.concat(pads);
    }

    function concatBytes(arrays) {
        let total = [];
        arrays.forEach(arr => { total = total.concat(arr); });
        return total;
    }

    function bytesToString(bytes) {
        return Encoding.convert(bytes, {to: 'UNICODE', from: 'SJIS', type: 'string'});
    }

    let currentSjisBytes = [];
    let currentDisplayString = "";
    let currentCanvas = null;

    function generateMenuData() {
        const storeCode = document.getElementById('store_code').value;
        const itemCode = document.getElementById('item_code').value;
        const taxRate = document.getElementById('tax_rate').value;
        const isReduced = document.getElementById('reduced_tax').checked;
        const itemName = document.getElementById('item_name').value;
        const price = document.getElementById('price_ex_tax').value;
        
        const calc = calculatePreview();
        const taxAmt = calc.taxAmt;
        const totalDesc = document.getElementById('price_display').value;

        const CODE_K = toSjisBytes("K");
        const COMMA = toSjisBytes(",");
        const STAR = toSjisBytes("*");
        const SPACE = toSjisBytes(" ");
        
        const b_store = padBytes(toSjisBytes(storeCode), 4, 0x30, 'right');
        const b_item = padBytes(toSjisBytes(itemCode), 4, 0x30, 'right');
        const b_rate = padBytes(toSjisBytes(taxRate), 2, 0x30, 'right');
        const b_reduced = isReduced ? STAR : SPACE;
        const b_name = padBytes(toSjisBytes(itemName), 20, 0x20, 'left');
        const b_price = padBytes(toSjisBytes(price), 6, 0x20, 'left');
        const b_tax = padBytes(toSjisBytes(taxAmt.toString()), 5, 0x20, 'left');

        const fullBytes = concatBytes([
            CODE_K,
            b_store, COMMA,
            b_item, COMMA,
            b_rate, 
            b_reduced, COMMA,
            b_name, COMMA,
            b_price, COMMA,
            b_tax
        ]);

        currentSjisBytes = fullBytes;
        currentDisplayString = bytesToString(fullBytes);

        document.getElementById('generated_string').innerText = currentDisplayString;

        drawCompositeImage(itemName, totalDesc);

        document.getElementById('btn_save').disabled = false;
        document.getElementById('btn_copy').disabled = false;
        document.getElementById('btn_print').disabled = false;
        
        showResult("データ生成完了 (48bytes)", true);
        
        // 生成時にも念のため保存しておく（誤ってリロードしたとき用）
        saveFormData();
    }

    function drawCompositeImage(topText, bottomText) {
        let binaryString = "";
        for (let i = 0; i < currentSjisBytes.length; i++) {
            binaryString += String.fromCharCode(currentSjisBytes[i]);
        }
        
        const qr = qrcode(0, 'M');
        qr.addData(binaryString, 'Byte');
        qr.make();
        
        const cellSize = 12; 
        const margin = 20;   
        const qrSize = qr.getModuleCount() * cellSize;
        
        const fontSize = 32; 
        
        const canvasWidth = Math.max(400, qrSize + margin * 2);
        const canvasHeight = margin + fontSize + margin + qrSize + margin + fontSize + margin;

        const canvas = document.createElement('canvas');
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        const ctx = canvas.getContext('2d');

        ctx.imageSmoothingEnabled = false;

        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);

        ctx.fillStyle = '#000000';
        ctx.font = 'bold ' + fontSize + 'px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        ctx.fillText(topText, canvasWidth / 2, margin + fontSize / 2);

        const qrTop = margin + fontSize + margin;
        const qrLeft = (canvasWidth - qrSize) / 2;
        
        for (let r = 0; r < qr.getModuleCount(); r++) {
            for (let c = 0; c < qr.getModuleCount(); c++) {
                if (qr.isDark(r, c)) {
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(Math.floor(qrLeft + c * cellSize), Math.floor(qrTop + r * cellSize), cellSize, cellSize);
                }
            }
        }

        ctx.fillStyle = '#000000';
        const priceTop = qrTop + qrSize + margin + fontSize / 2;
        ctx.fillText(bottomText, canvasWidth / 2, priceTop);

        const displayArea = document.getElementById('qr_display_area');
        displayArea.innerHTML = '';
        const img = document.createElement('img');
        img.src = canvas.toDataURL('image/png');
        displayArea.appendChild(img);

        currentCanvas = canvas;
    }

    function saveQRImage() {
        if (!currentCanvas) return;
        
        const itemCode = document.getElementById('item_code').value || '0000';
        const itemName = document.getElementById('item_name').value || 'item';

        const safeItemName = itemName.replace(/[\\/:*?"<>|]/g, '_');
        const filename = itemCode + '_' + safeItemName + '.png';

        const link = document.createElement('a');
        link.href = currentCanvas.toDataURL('image/png');
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function copyToClipboard() {
        if (!currentDisplayString) return;
        navigator.clipboard.writeText(currentDisplayString).then(function() {
            showResult("データをコピーしました", true);
        }, function(err) {
            showResult("コピーに失敗しました", false);
        });
    }

    function sendPrintRequest() {
        if (!currentDisplayString) return;

        // ★ここでフォームの状態を保存する
        saveFormData();

        const scheme = "brotherwebprint://print";
        const filename = document.getElementById("input_printfile").value;
        const size = document.getElementById("input_binfile").value;
        const copies = document.getElementById("input_quantity").value;
        const text1 = document.getElementById("item_name").value;
        const text2 = document.getElementById("price_display").value;
        
        const qrCodeData = currentDisplayString; 

        const baseUrl = window.location.href.split('?')[0];
        const successURL = encodeURIComponent(baseUrl + '?result=success');
        const failureURL = encodeURIComponent(baseUrl + '?result=fail');

        const url = scheme + '?' +
            'filename=' + encodeURIComponent(filename) + '&' +
            'size=' + encodeURIComponent(size) + '&' +
            'copies=' + encodeURIComponent(copies) + '&' +
            'barcode_QRcode=' + encodeURIComponent(qrCodeData) + '&' +
            'text_ItemName=' + encodeURIComponent(text1) + '&' +
            'text_Price=' + encodeURIComponent(text2) + '&' +
            'successCallback=' + successURL + '&' +
            'failureCallback=' + failureURL;

        location.href = url;
    }

    function showResult(msg, isSuccess) {
        const el = document.getElementById('result_message');
        el.innerText = msg;
        el.className = isSuccess ? 'success' : 'error';
    }
</script>
</body>
</html>